##### WSO-Config WSO 2.0 #####

- name: Download Grafana GPG signing key
  ansible.builtin.get_url:
    url: https://rpm.grafana.com/gpg.key
    dest: /tmp/grafana-gpg.key

- name: Import Grafana GPG signing key
  ansible.builtin.shell: sudo rpm --import /tmp/grafana-gpg.key

- name: Copy Grafana repository
  ansible.builtin.copy:
    src: grafana.repo
    force: yes
    dest: /etc/yum.repos.d/grafana.repo

- name: Update DNF cache after adding repo
  ansible.builtin.dnf:
    update_cache: yes

- name: Install Grafana
  ansible.builtin.dnf:
    name: grafana
    state: present

- name: Copy Grafana service file
  ansible.builtin.copy:
    src: grafana.service
    force: yes
    dest: /usr/lib/systemd/system/

- name: Refresh systemd service file cache
  ansible.builtin.shell: systemctl daemon-reload

- name: Copy Grafana configuration file
  ansible.builtin.copy:
    src: grafana-config.ini
    force: yes
    dest: /etc/grafana/

# TODO: apparently you can do this in Ansible nowadays,
# so we should stop doing it this old-fashioned way.
- name: Copy Grafana DB file
  ansible.builtin.copy:
    src: grafana.db
    force: yes
    dest: /var/lib/grafana/

- name: Enable and start Grafana
  systemd:
    name: grafana
    enabled: yes
    state: started
    
  
